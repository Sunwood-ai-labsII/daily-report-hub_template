name: 📊 デイリーレポートハブ同期 v2.4 (YUKIHIKO PR版)
on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, synchronize, closed]

env:
  WEEK_START_DAY: 1
  AUTO_APPROVE: true
  AUTO_MERGE: true  
  CREATE_PR: true

jobs:
  sync-data:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 現在のリポジトリをチェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 スクリプトを実行可能にする
        run: chmod +x .github/scripts/*.sh

      - name: 📅 週情報を計算
        run: ./.github/scripts/calculate-week-info.sh ${{ env.WEEK_START_DAY }}

      - name: 🔍 Git活動を分析
        run: ./.github/scripts/analyze-git-activity.sh

      - name: 📝 Markdownレポートを生成
        run: ./.github/scripts/generate-markdown-reports.sh

      - name: 📂 レポートハブをクローン
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          REPORT_HUB_REPO: ${{ vars.REPORT_HUB_REPO || 'Sunwood-ai-labsII/daily-report-hub' }}
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${REPORT_HUB_REPO}.git daily-report-hub

      - name: 🏗️ Docusaurus構造を作成
        run: ./.github/scripts/create-docusaurus-structure.sh

      - name: 🚀 YUKIHIKO権限でPR作成＆自動承認
        env:
          GITHUB_TOKEN_ORIGINAL: ${{ secrets.GH_PAT }}      # 承認用
          YUKIHIKO_TOKEN: ${{ secrets.GH_PAT_YUKIHIKO }}     # PR作成用
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}              # デフォルト
          REPORT_HUB_REPO: ${{ vars.REPORT_HUB_REPO || 'Sunwood-ai-labsII/daily-report-hub' }}
        run: ./.github/scripts/sync-to-hub-gh.sh
